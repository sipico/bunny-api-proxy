name: CI

on:
  push:
    branches: [ main, 'claude/**' ]
    paths-ignore:
      - '.claude/**'
      - '**/*.md'
      - 'docs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - '.claude/**'
      - '**/*.md'
      - 'docs/**'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Download dependencies
        run: go mod download

      - name: Run tests with coverage
        run: go test -race -coverprofile=coverage.txt -covermode=atomic ./...

      - name: Install go-test-coverage
        run: go install github.com/vladopajic/go-test-coverage/v2@latest

      - name: Check test coverage
        run: go-test-coverage --config .testcoverage.yml

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run gofmt
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "The following files are not formatted with gofmt:"
            gofmt -l .
            exit 1
          fi

      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v9
        with:
          version: v2.8.0

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      - name: Build binary
        run: go build -o bunny-api-proxy ./cmd/bunny-api-proxy

      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: bunny-api-proxy
          path: bunny-api-proxy
          retention-days: 7

  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: bunny-api-proxy:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

  e2e-test:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [test, lint]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test data directory
        run: |
          rm -rf /tmp/proxy-data
          mkdir -p /tmp/proxy-data
          chmod 777 /tmp/proxy-data

      - name: Build and start services (Mock Mode)
        run: |
          docker compose -f .claude/docker/docker-compose.test.yml --profile mock up -d --build

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services..."
          timeout 60 bash -c 'until docker compose -f .claude/docker/docker-compose.test.yml ps | grep -q "healthy"; do sleep 2; done'
          docker compose -f .claude/docker/docker-compose.test.yml ps

      - name: Run E2E tests
        run: |
          mkdir -p e2e-logs
          set -o pipefail
          docker compose -f .claude/docker/docker-compose.test.yml run --rm test-runner 2>&1 | tee e2e-logs/test-runner.log

      - name: Collect logs
        if: always()
        run: |
          mkdir -p e2e-logs
          docker compose -f .claude/docker/docker-compose.test.yml logs proxy > e2e-logs/proxy.log 2>&1 || true
          docker compose -f .claude/docker/docker-compose.test.yml logs mockbunny > e2e-logs/mockbunny.log 2>&1 || true
          docker compose -f .claude/docker/docker-compose.test.yml ps > e2e-logs/services.log 2>&1 || true

      - name: Upload E2E logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: e2e-logs/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f .claude/docker/docker-compose.test.yml down -v

  e2e-test-real-api:
    name: E2E Tests (Real Bunny.net API)
    runs-on: ubuntu-latest
    needs: [test, lint]
    # Only run on: PRs to main, pushes to main, or manual trigger
    if: |
      (github.event_name == 'pull_request' && github.base_ref == 'main') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create test data directory
        run: |
          rm -rf /tmp/proxy-data
          mkdir -p /tmp/proxy-data
          chmod 777 /tmp/proxy-data

      - name: Build and start services (Real API Mode)
        env:
          BUNNY_API_KEY: ${{ secrets.BUNNY_API_TEST_KEY }}
          BUNNY_API_URL: https://api.bunny.net
          MOCKBUNNY_URL: ""  # Disable mockbunny URL for TestEnv
        run: |
          # No --profile mock: skips mockbunny, only proxy
          docker compose -f .claude/docker/docker-compose.test.yml up -d --build proxy

      - name: Wait for proxy to be healthy
        run: |
          echo "Waiting for proxy..."
          timeout 60 bash -c 'until docker compose -f .claude/docker/docker-compose.test.yml ps proxy | grep -q "healthy"; do sleep 2; done'
          docker compose -f .claude/docker/docker-compose.test.yml ps

      - name: Run E2E tests against real API
        env:
          BUNNY_API_KEY: ${{ secrets.BUNNY_API_TEST_KEY }}
          BUNNY_API_URL: https://api.bunny.net
        run: |
          mkdir -p e2e-logs
          set -o pipefail
          docker compose -f .claude/docker/docker-compose.test.yml run --rm \
            -e BUNNY_TEST_MODE=real \
            -e BUNNY_API_KEY=$BUNNY_API_KEY \
            test-runner 2>&1 | tee e2e-logs/test-runner.log

      - name: Collect logs
        if: always()
        run: |
          mkdir -p e2e-logs
          docker compose -f .claude/docker/docker-compose.test.yml logs proxy > e2e-logs/proxy.log 2>&1 || true
          docker compose -f .claude/docker/docker-compose.test.yml ps > e2e-logs/services.log 2>&1 || true

      - name: Upload E2E logs (Real API)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs-real-api
          path: e2e-logs/
          retention-days: 7

      - name: Cleanup
        if: always()
        run: |
          docker compose -f .claude/docker/docker-compose.test.yml down -v
