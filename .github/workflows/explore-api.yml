name: Explore bunny.net API

# Manual trigger only - run this to explore API behavior
on:
  workflow_dispatch:

jobs:
  explore:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "BUNNY_API_URL=https://api.bunny.net" >> $GITHUB_ENV
          echo "Starting API exploration - BASIC TEST"

      # =================================================================
      # STEP 1: CLEANUP - Clear all zones from account
      # =================================================================
      - name: Step 1 - List existing zones
        run: |
          echo "=========================================="
          echo "STEP 1: List all existing zones"
          echo "=========================================="

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-before.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.'

      - name: Step 1 - Extract zone IDs
        run: |
          echo "=========================================="
          echo "STEP 1: Extract zone IDs for deletion"
          echo "=========================================="

          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq -r '.Items[]?.Id // empty' > zone-ids.txt

          echo "Found zone IDs:"
          cat zone-ids.txt

          ZONE_COUNT=$(wc -l < zone-ids.txt | tr -d ' ')
          echo "Total zones to delete: $ZONE_COUNT"

      - name: Step 1 - Delete all existing zones
        run: |
          echo "=========================================="
          echo "STEP 1: Delete all existing zones"
          echo "=========================================="

          if [ ! -s zone-ids.txt ]; then
            echo "‚úì No zones to delete - account is already empty"
            exit 0
          fi

          while read -r zone_id; do
            if [ -n "$zone_id" ]; then
              echo ""
              echo "‚Üí Deleting zone ID: $zone_id"

              curl -v -X DELETE \
                -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
                "$BUNNY_API_URL/dnszone/$zone_id" \
                2>&1 | tee "delete-zone-${zone_id}.log"

              echo "‚úì Deleted zone $zone_id"
              sleep 1
            fi
          done < zone-ids.txt

          echo ""
          echo "‚úì All zones deleted"

      # =================================================================
      # STEP 2: VERIFY - Account should be empty
      # =================================================================
      - name: Step 2 - Verify account is empty
        run: |
          echo "=========================================="
          echo "STEP 2: Verify account is empty"
          echo "=========================================="

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-after-cleanup.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee zones-empty.json

          ZONE_COUNT=$(jq '.Items | length' zones-empty.json)
          echo ""
          echo "Zone count: $ZONE_COUNT"

          if [ "$ZONE_COUNT" != "0" ]; then
            echo "‚úó ERROR: Account is not empty after cleanup!"
            exit 1
          fi

          echo "‚úì Account is empty"

      # =================================================================
      # STEP 3: CREATE - Add a fake test zone
      # =================================================================
      - name: Step 3 - Create fake test zone
        run: |
          echo "=========================================="
          echo "STEP 3: Create fake test zone"
          echo "=========================================="

          curl -v -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "test-basic-explore.xyz"}' \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee create-test-zone.log

          echo ""
          echo "Pretty-printed:"
          curl -s -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "test-basic-explore.xyz"}' \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee test-zone.json

          # Save zone ID for cleanup
          TEST_ZONE_ID=$(jq -r '.Id' test-zone.json)
          echo "TEST_ZONE_ID=$TEST_ZONE_ID" >> $GITHUB_ENV

          echo ""
          echo "‚úì Created test zone ID: $TEST_ZONE_ID"

      - name: Step 3 - Verify zone was created
        run: |
          echo "=========================================="
          echo "STEP 3: Verify zone was created"
          echo "=========================================="

          echo "Listing all zones to verify creation..."

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-after-create.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee zones-list.json

          ZONE_COUNT=$(jq '.Items | length' zones-list.json)
          echo ""
          echo "Zone count: $ZONE_COUNT"

          if [ "$ZONE_COUNT" != "1" ]; then
            echo "‚úó ERROR: Expected 1 zone, found $ZONE_COUNT"
            exit 1
          fi

          ZONE_DOMAIN=$(jq -r '.Items[0].Domain' zones-list.json)
          echo "Zone domain: $ZONE_DOMAIN"

          if [ "$ZONE_DOMAIN" != "test-basic-explore.xyz" ]; then
            echo "‚úó ERROR: Wrong domain found: $ZONE_DOMAIN"
            exit 1
          fi

          echo "‚úì Zone created successfully and visible in list"

      # =================================================================
      # STEP 3b: DNS QUERY - Check if amazon.com exists on bunny.net nameservers
      # =================================================================
      - name: Step 3b - Query amazon.com via DNS
        run: |
          echo "=========================================="
          echo "STEP 3b: DNS queries for amazon.com"
          echo "=========================================="
          echo "Question: Is amazon.com actually hosted on bunny.net nameservers?"
          echo ""

          echo "--- Query via Bunny.net nameserver (kiki.bunny.net) ---"
          dig @kiki.bunny.net amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Query via Bunny.net nameserver (coco.bunny.net) ---"
          dig @coco.bunny.net amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Query via Cloudflare (1.1.1.1) ---"
          dig @1.1.1.1 amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Query via Quad9 (9.9.9.9) ---"
          dig @9.9.9.9 amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Check amazon.com nameservers ---"
          dig amazon.com NS +short || echo "Query failed"

      # =================================================================
      # STEP 3c: EXPLORE - Try to add amazon.com
      # =================================================================
      - name: Step 3c - Try to create amazon.com zone
        run: |
          echo "=========================================="
          echo "STEP 3c: Try to add amazon.com as a zone"
          echo "=========================================="
          echo "Question: Can we add a well-known domain we don't own?"
          echo ""

          curl -v -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "amazon.com"}' \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee create-amazon-zone.log

          echo ""
          echo "Pretty-printed:"
          curl -s -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "amazon.com"}' \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee amazon-zone.json || echo "Request failed or returned non-JSON"

          # Check if it succeeded
          AMAZON_ZONE_ID=$(jq -r '.Id // empty' amazon-zone.json 2>/dev/null)
          if [ -n "$AMAZON_ZONE_ID" ]; then
            echo ""
            echo "ü§Ø SURPRISE: We CAN add amazon.com! Zone ID: $AMAZON_ZONE_ID"
            echo "AMAZON_ZONE_ID=$AMAZON_ZONE_ID" >> $GITHUB_ENV
          else
            echo ""
            echo "‚ùå As expected: Cannot add amazon.com (we don't own it)"
          fi

      # =================================================================
      # STEP 3d: EXPLORE - Try several large EU companies
      # =================================================================
      - name: Step 3d - Try to create zones for EU companies
        run: |
          echo "=========================================="
          echo "STEP 3d: Try large EU company domains"
          echo "=========================================="
          echo "Question: Are all well-known domains blocked, or just some?"
          echo ""

          # List of large EU companies to test
          DOMAINS=(
            "siemens.com"
            "shell.com"
            "nestle.com"
            "sap.com"
            "lvmh.com"
            "unilever.com"
          )

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Testing: $domain"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Make single request, save verbose output and JSON response
            curl -v -X POST \
              -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"Domain\": \"$domain\"}" \
              "$BUNNY_API_URL/dnszone" \
              2>&1 | tee "create-${domain}.log"

            echo ""
            echo "Pretty-printed:"
            # Extract just the JSON body from the log (last line)
            RESPONSE=$(tail -1 "create-${domain}.log")
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

            # Check if it succeeded
            ZONE_ID=$(echo "$RESPONSE" | jq -r '.Id // empty' 2>/dev/null)
            if [ -n "$ZONE_ID" ] && [ "$ZONE_ID" != "null" ]; then
              echo "‚úÖ SUCCESS: Created zone for $domain (ID: $ZONE_ID)"
              echo "ZONE_${domain/./_}=$ZONE_ID" >> $GITHUB_ENV
            else
              echo "‚ùå BLOCKED: Cannot add $domain"
            fi

            # Small delay between requests
            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: EU Company Domain Tests"
          echo "=========================================="

      # =================================================================
      # STEP 3e: EXPLORE - Domain availability checks
      # =================================================================
      - name: Step 3e - Test domain availability endpoint
        run: |
          echo "=========================================="
          echo "STEP 3e: Domain availability checks"
          echo "=========================================="
          echo "Testing: POST /dnszone/checkavailability"
          echo ""

          # Use EU company domains
          DOMAINS=(
            "siemens.com"
            "shell.com"
            "nestle.com"
            "sap.com"
            "lvmh.com"
            "unilever.com"
          )

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Checking availability: $domain"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            curl -v -X POST \
              -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"Name\": \"$domain\"}" \
              "$BUNNY_API_URL/dnszone/checkavailability" \
              2>&1 | tee "availability-${domain}.log"

            echo ""
            echo "Pretty-printed:"
            RESPONSE=$(tail -1 "availability-${domain}.log")
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

            # Small delay between requests
            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: Domain Availability Tests"
          echo "=========================================="

      # =================================================================
      # STEP 3f: EXPLORE - DNS scanning
      # =================================================================
      - name: Step 3f - Test DNS scanning endpoint
        run: |
          echo "=========================================="
          echo "STEP 3f: DNS scanning tests"
          echo "=========================================="
          echo "Testing: POST /dnszone/records/scan"
          echo ""

          # Use EU company domains (already created in Step 3d)
          DOMAINS=(
            "siemens.com"
            "shell.com"
            "nestle.com"
          )

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Scanning DNS records: $domain"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Trigger scan using Domain parameter
            curl -v -X POST \
              -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"Domain\": \"$domain\"}" \
              "$BUNNY_API_URL/dnszone/records/scan" \
              2>&1 | tee "scan-${domain}.log"

            echo ""
            echo "Pretty-printed:"
            RESPONSE=$(tail -1 "scan-${domain}.log")
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

            # Extract JobId if scan was triggered
            JOB_ID=$(echo "$RESPONSE" | jq -r '.JobId // empty' 2>/dev/null)
            if [ -n "$JOB_ID" ]; then
              echo "‚úÖ Scan triggered for $domain (JobId: $JOB_ID)"
              echo "JOB_${domain/./_}=$JOB_ID" >> $GITHUB_ENV
            fi

            # Small delay between requests
            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: DNS Scanning Tests"
          echo "=========================================="

      # =================================================================
      # STEP 3g: EXPLORE - Poll DNS scan results
      # =================================================================
      - name: Step 3g - Poll DNS scan results
        run: |
          echo "=========================================="
          echo "STEP 3g: Poll DNS scan results"
          echo "=========================================="
          echo "Testing: GET /dnszone/{zoneId}/records/scan"
          echo ""

          # First, get zone IDs for the domains we scanned
          echo "Getting zone IDs for scanned domains..."
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.Items[] | select(.Domain == "siemens.com" or .Domain == "shell.com" or .Domain == "nestle.com") | {Domain, Id}' \
            > scanned-zones.json

          cat scanned-zones.json

          # Wait a bit for scans to process
          echo ""
          echo "Waiting 5 seconds for scans to process..."
          sleep 5

          # Poll each zone's scan results
          DOMAINS=("siemens.com" "shell.com" "nestle.com")

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Checking scan results: $domain"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Get zone ID for this domain
            ZONE_ID=$(jq -r "select(.Domain == \"$domain\") | .Id" scanned-zones.json)

            if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "null" ]; then
              echo "‚ö†Ô∏è  Could not find zone ID for $domain"
              continue
            fi

            echo "Zone ID: $ZONE_ID"
            echo ""

            # Poll scan status (try 3 times with delays)
            for attempt in 1 2 3; do
              echo "Attempt $attempt - Fetching scan results..."

              curl -v -X GET \
                -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
                "$BUNNY_API_URL/dnszone/$ZONE_ID/records/scan" \
                2>&1 | tee "scan-result-${domain}-attempt${attempt}.log"

              echo ""
              echo "‚úÖ Response saved to scan-result-${domain}-attempt${attempt}.log"
              echo "(Raw output will be available in artifacts for offline analysis)"

              # Small delay before next attempt
              if [ $attempt -lt 3 ]; then
                echo "Waiting 3 seconds before next poll..."
                sleep 3
              fi
            done

            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: DNS Scan Results"
          echo "=========================================="

      # =================================================================
      # STEP 3h: EXPLORE - Add records from scan results
      # =================================================================
      - name: Step 3h - Add records from scan results
        run: |
          echo "=========================================="
          echo "STEP 3h: Add records from scan results"
          echo "=========================================="
          echo "Testing: PUT /dnszone/{id}/records"
          echo ""

          # Test with first 3 domains
          DOMAINS=("siemens.com" "shell.com" "nestle.com")

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Adding records for: $domain"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Get zone ID
            ZONE_ID=$(curl -s -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" "$BUNNY_API_URL/dnszone" | jq -r ".Items[] | select(.Domain == \"$domain\") | .Id")

            if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "null" ]; then
              echo "‚ö†Ô∏è  Zone not found for $domain, skipping"
              continue
            fi

            echo "Zone ID: $ZONE_ID"

            # Find the latest scan result file
            SCAN_FILE=$(ls -t scan-result-${domain}-attempt*.log 2>/dev/null | head -1)

            if [ ! -f "$SCAN_FILE" ]; then
              echo "‚ö†Ô∏è  No scan results found for $domain"
              continue
            fi

            echo "Using scan results from: $SCAN_FILE"

            # Extract and parse scan results, then add first 5 records as test
            python3 << 'PYTHON_EOF'
import json
import subprocess
import sys
import re

domain = sys.argv[1]
zone_id = sys.argv[2]
scan_file = sys.argv[3]
api_key = sys.argv[4]
api_url = sys.argv[5]

# Read scan results
with open(scan_file, 'r') as f:
    content = f.read()
    match = re.search(r'(\{"JobId".*?\})(?:\s*\d+\s+\d+\s+\d+|$)', content, re.DOTALL)
    if not match:
        print(f"Could not find JSON in {scan_file}")
        sys.exit(0)

    # Clean control characters
    json_str = match.group(1)
    json_str = ''.join(c for c in json_str if ord(c) >= 32 or c in '\n\r\t')

    try:
        data = json.loads(json_str)
        records = data.get('Records', [])

        if not records:
            print(f"No records found in scan results")
            sys.exit(0)

        print(f"Found {len(records)} records in scan")
        print(f"Adding first 5 records as test...")

        for i, record in enumerate(records[:5]):
            # Convert scan record to AddRecordRequest format
            add_req = {
                "Type": record["Type"],
                "Name": record["Name"],
                "Value": record["Value"],
                "Ttl": record["Ttl"],
                "Priority": record.get("Priority") or 0,
                "Weight": record.get("Weight") or 0,
                "Port": record.get("Port") or 0,
                "Flags": 0,
                "Tag": "",
                "Disabled": False,
                "Comment": f"Added from scan result"
            }

            print(f"\n  Record {i+1}: Type={add_req['Type']} Name={add_req['Name']}")

            # Add record via API
            result = subprocess.run([
                'curl', '-s', '-X', 'PUT',
                '-H', f'AccessKey: {api_key}',
                '-H', 'Content-Type: application/json',
                '-d', json.dumps(add_req),
                f'{api_url}/dnszone/{zone_id}/records'
            ], capture_output=True, text=True)

            if result.returncode == 0:
                try:
                    resp = json.loads(result.stdout)
                    if resp.get('Id'):
                        print(f"    ‚úÖ Created record ID: {resp['Id']}")
                    else:
                        print(f"    ‚ö†Ô∏è  Response: {result.stdout[:100]}")
                except:
                    print(f"    ‚ö†Ô∏è  Could not parse response")
            else:
                print(f"    ‚ùå Failed: {result.stderr[:100]}")

    except Exception as e:
        print(f"Error processing scan results: {e}")
        sys.exit(0)

PYTHON_EOF
            python3 -c "$(cat)" "$domain" "$ZONE_ID" "$SCAN_FILE" "${{ secrets.BUNNY_API_TEST_KEY }}" "$BUNNY_API_URL" << 'PYTHON_EOF'
import json
import subprocess
import sys
import re

domain = sys.argv[1]
zone_id = sys.argv[2]
scan_file = sys.argv[3]
api_key = sys.argv[4]
api_url = sys.argv[5]

with open(scan_file, 'r') as f:
    content = f.read()
    match = re.search(r'(\{"JobId".*?\})(?:\s*\d+|$)', content, re.DOTALL)
    if match:
        json_str = ''.join(c for c in match.group(1) if ord(c) >= 32 or c in '\n\r\t')
        try:
            data = json.loads(json_str)
            records = data.get('Records', [])
            print(f"Adding first 5 of {len(records)} records...")
            for i, r in enumerate(records[:5]):
                req = {"Type": r["Type"], "Name": r["Name"], "Value": r["Value"], "Ttl": r["Ttl"], "Priority": r.get("Priority") or 0, "Weight": r.get("Weight") or 0, "Port": r.get("Port") or 0}
                result = subprocess.run(['curl', '-s', '-X', 'PUT', '-H', f'AccessKey: {api_key}', '-H', 'Content-Type: application/json', '-d', json.dumps(req), f'{api_url}/dnszone/{zone_id}/records'], capture_output=True, text=True)
                resp = json.loads(result.stdout) if result.returncode == 0 else {}
                print(f"  {i+1}. Type={r['Type']} {r['Name']}: {'‚úÖ ID='+str(resp.get('Id')) if resp.get('Id') else '‚ùå'}")
        except Exception as e:
            print(f"Error: {e}")
PYTHON_EOF

            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: Records Added"
          echo "=========================================="

      # =================================================================
      # STEP 3i: EXPLORE - Export zones
      # =================================================================
      - name: Step 3i - Export zones
        run: |
          echo "=========================================="
          echo "STEP 3i: Export zones to BIND format"
          echo "=========================================="
          echo "Testing: GET /dnszone/{id}/export"
          echo ""

          DOMAINS=("siemens.com" "shell.com" "nestle.com")

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "Exporting zone: $domain"
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

            # Get zone ID
            ZONE_ID=$(curl -s -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" "$BUNNY_API_URL/dnszone" | jq -r ".Items[] | select(.Domain == \"$domain\") | .Id")

            if [ -z "$ZONE_ID" ] || [ "$ZONE_ID" = "null" ]; then
              echo "‚ö†Ô∏è  Zone not found for $domain"
              continue
            fi

            echo "Zone ID: $ZONE_ID"
            echo "Exporting..."

            curl -v -X GET \
              -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
              "$BUNNY_API_URL/dnszone/$ZONE_ID/export" \
              2>&1 | tee "export-${domain}.log"

            # Extract the zone file (non-curl output)
            grep -v "^[\*<>]" "export-${domain}.log" | grep -v "^{" > "export-${domain}.zone" || true

            if [ -s "export-${domain}.zone" ]; then
              echo ""
              echo "‚úÖ Exported to export-${domain}.zone"
              echo "Preview (first 10 lines):"
              head -10 "export-${domain}.zone"
            else
              echo "‚ö†Ô∏è  Export file is empty or failed"
            fi

            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: Zone Exports"
          echo "=========================================="

      # =================================================================
      # STEP 4: CLEANUP - Delete the test zone
      # =================================================================
      - name: Step 4 - Delete test zone
        if: always()
        run: |
          echo "=========================================="
          echo "STEP 4: Cleanup - Delete test zone"
          echo "=========================================="

          # Get all zone IDs
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq -r '.Items[]?.Id // empty' > zone-ids-final.txt

          if [ ! -s zone-ids-final.txt ]; then
            echo "‚úì No zones to delete"
            exit 0
          fi

          echo "Zones to delete:"
          cat zone-ids-final.txt

          while read -r zone_id; do
            if [ -n "$zone_id" ]; then
              echo ""
              echo "‚Üí Deleting zone ID: $zone_id"

              curl -v -X DELETE \
                -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
                "$BUNNY_API_URL/dnszone/$zone_id" \
                2>&1 | tee "cleanup-zone-${zone_id}.log"

              echo "‚úì Deleted zone $zone_id"
              sleep 1
            fi
          done < zone-ids-final.txt

      - name: Step 4 - Verify final cleanup
        if: always()
        run: |
          echo "=========================================="
          echo "STEP 4: Verify final cleanup"
          echo "=========================================="

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-final.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.'

          ZONE_COUNT=$(curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.Items | length')

          echo ""
          echo "Final zone count: $ZONE_COUNT"

          if [ "$ZONE_COUNT" != "0" ]; then
            echo "‚úó WARNING: Account is not empty after cleanup!"
            exit 1
          fi

          echo "‚úì Account is empty - cleanup successful"

      # =================================================================
      # SUMMARY
      # =================================================================
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "BASIC TEST SUMMARY"
          echo "=========================================="
          echo ""
          echo "‚úì Step 1: Cleanup - Deleted existing zones"
          echo "‚úì Step 2: Verify - Confirmed account empty"
          echo "‚úì Step 3: Create - Added test zone"
          echo "‚úì Step 4: Cleanup - Removed test zone"
          echo ""
          echo "All basic operations working! ‚úÖ"
          echo ""
          echo "Next: Add more exploration steps as needed"

      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: basic-test-logs
          path: |
            *.log
            *.json
            *.txt
          retention-days: 30
