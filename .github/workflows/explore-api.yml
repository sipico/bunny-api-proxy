name: Explore bunny.net API

# Manual trigger only - run this to explore API behavior
on:
  workflow_dispatch:

jobs:
  explore:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up environment
        run: |
          echo "BUNNY_API_URL=https://api.bunny.net" >> $GITHUB_ENV
          echo "Starting API exploration - BASIC TEST"

      # =================================================================
      # STEP 1: CLEANUP - Clear all zones from account
      # =================================================================
      - name: Step 1 - List existing zones
        run: |
          echo "=========================================="
          echo "STEP 1: List all existing zones"
          echo "=========================================="

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-before.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.'

      - name: Step 1 - Extract zone IDs
        run: |
          echo "=========================================="
          echo "STEP 1: Extract zone IDs for deletion"
          echo "=========================================="

          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq -r '.Items[]?.Id // empty' > zone-ids.txt

          echo "Found zone IDs:"
          cat zone-ids.txt

          ZONE_COUNT=$(wc -l < zone-ids.txt | tr -d ' ')
          echo "Total zones to delete: $ZONE_COUNT"

      - name: Step 1 - Delete all existing zones
        run: |
          echo "=========================================="
          echo "STEP 1: Delete all existing zones"
          echo "=========================================="

          if [ ! -s zone-ids.txt ]; then
            echo "âœ“ No zones to delete - account is already empty"
            exit 0
          fi

          while read -r zone_id; do
            if [ -n "$zone_id" ]; then
              echo ""
              echo "â†’ Deleting zone ID: $zone_id"

              curl -v -X DELETE \
                -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
                "$BUNNY_API_URL/dnszone/$zone_id" \
                2>&1 | tee "delete-zone-${zone_id}.log"

              echo "âœ“ Deleted zone $zone_id"
              sleep 1
            fi
          done < zone-ids.txt

          echo ""
          echo "âœ“ All zones deleted"

      # =================================================================
      # STEP 2: VERIFY - Account should be empty
      # =================================================================
      - name: Step 2 - Verify account is empty
        run: |
          echo "=========================================="
          echo "STEP 2: Verify account is empty"
          echo "=========================================="

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-after-cleanup.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee zones-empty.json

          ZONE_COUNT=$(jq '.Items | length' zones-empty.json)
          echo ""
          echo "Zone count: $ZONE_COUNT"

          if [ "$ZONE_COUNT" != "0" ]; then
            echo "âœ— ERROR: Account is not empty after cleanup!"
            exit 1
          fi

          echo "âœ“ Account is empty"

      # =================================================================
      # STEP 3: CREATE - Add a fake test zone
      # =================================================================
      - name: Step 3 - Create fake test zone
        run: |
          echo "=========================================="
          echo "STEP 3: Create fake test zone"
          echo "=========================================="

          curl -v -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "test-basic-explore.xyz"}' \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee create-test-zone.log

          echo ""
          echo "Pretty-printed:"
          curl -s -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "test-basic-explore.xyz"}' \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee test-zone.json

          # Save zone ID for cleanup
          TEST_ZONE_ID=$(jq -r '.Id' test-zone.json)
          echo "TEST_ZONE_ID=$TEST_ZONE_ID" >> $GITHUB_ENV

          echo ""
          echo "âœ“ Created test zone ID: $TEST_ZONE_ID"

      - name: Step 3 - Verify zone was created
        run: |
          echo "=========================================="
          echo "STEP 3: Verify zone was created"
          echo "=========================================="

          echo "Listing all zones to verify creation..."

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-after-create.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee zones-list.json

          ZONE_COUNT=$(jq '.Items | length' zones-list.json)
          echo ""
          echo "Zone count: $ZONE_COUNT"

          if [ "$ZONE_COUNT" != "1" ]; then
            echo "âœ— ERROR: Expected 1 zone, found $ZONE_COUNT"
            exit 1
          fi

          ZONE_DOMAIN=$(jq -r '.Items[0].Domain' zones-list.json)
          echo "Zone domain: $ZONE_DOMAIN"

          if [ "$ZONE_DOMAIN" != "test-basic-explore.xyz" ]; then
            echo "âœ— ERROR: Wrong domain found: $ZONE_DOMAIN"
            exit 1
          fi

          echo "âœ“ Zone created successfully and visible in list"

      # =================================================================
      # STEP 3b: DNS QUERY - Check if amazon.com exists on bunny.net nameservers
      # =================================================================
      - name: Step 3b - Query amazon.com via DNS
        run: |
          echo "=========================================="
          echo "STEP 3b: DNS queries for amazon.com"
          echo "=========================================="
          echo "Question: Is amazon.com actually hosted on bunny.net nameservers?"
          echo ""

          echo "--- Query via Bunny.net nameserver (kiki.bunny.net) ---"
          dig @kiki.bunny.net amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Query via Bunny.net nameserver (coco.bunny.net) ---"
          dig @coco.bunny.net amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Query via Cloudflare (1.1.1.1) ---"
          dig @1.1.1.1 amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Query via Quad9 (9.9.9.9) ---"
          dig @9.9.9.9 amazon.com A +short || echo "Query failed"
          echo ""

          echo "--- Check amazon.com nameservers ---"
          dig amazon.com NS +short || echo "Query failed"

      # =================================================================
      # STEP 3c: EXPLORE - Try to add amazon.com
      # =================================================================
      - name: Step 3c - Try to create amazon.com zone
        run: |
          echo "=========================================="
          echo "STEP 3c: Try to add amazon.com as a zone"
          echo "=========================================="
          echo "Question: Can we add a well-known domain we don't own?"
          echo ""

          curl -v -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "amazon.com"}' \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee create-amazon-zone.log

          echo ""
          echo "Pretty-printed:"
          curl -s -X POST \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            -H "Content-Type: application/json" \
            -d '{"Domain": "amazon.com"}' \
            "$BUNNY_API_URL/dnszone" \
            | jq '.' | tee amazon-zone.json || echo "Request failed or returned non-JSON"

          # Check if it succeeded
          AMAZON_ZONE_ID=$(jq -r '.Id // empty' amazon-zone.json 2>/dev/null)
          if [ -n "$AMAZON_ZONE_ID" ]; then
            echo ""
            echo "ðŸ¤¯ SURPRISE: We CAN add amazon.com! Zone ID: $AMAZON_ZONE_ID"
            echo "AMAZON_ZONE_ID=$AMAZON_ZONE_ID" >> $GITHUB_ENV
          else
            echo ""
            echo "âŒ As expected: Cannot add amazon.com (we don't own it)"
          fi

      # =================================================================
      # STEP 3d: EXPLORE - Try several large EU companies
      # =================================================================
      - name: Step 3d - Try to create zones for EU companies
        run: |
          echo "=========================================="
          echo "STEP 3d: Try large EU company domains"
          echo "=========================================="
          echo "Question: Are all well-known domains blocked, or just some?"
          echo ""

          # List of large EU companies to test
          DOMAINS=(
            "siemens.com"
            "shell.com"
            "nestle.com"
            "sap.com"
            "lvmh.com"
            "unilever.com"
          )

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Testing: $domain"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Make single request, save verbose output and JSON response
            curl -v -X POST \
              -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"Domain\": \"$domain\"}" \
              "$BUNNY_API_URL/dnszone" \
              2>&1 | tee "create-${domain}.log"

            echo ""
            echo "Pretty-printed:"
            # Extract just the JSON body from the log (last line)
            RESPONSE=$(tail -1 "create-${domain}.log")
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

            # Check if it succeeded
            ZONE_ID=$(echo "$RESPONSE" | jq -r '.Id // empty' 2>/dev/null)
            if [ -n "$ZONE_ID" ] && [ "$ZONE_ID" != "null" ]; then
              echo "âœ… SUCCESS: Created zone for $domain (ID: $ZONE_ID)"
              echo "ZONE_${domain/./_}=$ZONE_ID" >> $GITHUB_ENV
            else
              echo "âŒ BLOCKED: Cannot add $domain"
            fi

            # Small delay between requests
            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: EU Company Domain Tests"
          echo "=========================================="

      # =================================================================
      # STEP 3e: EXPLORE - Domain availability checks
      # =================================================================
      - name: Step 3e - Test domain availability endpoint
        run: |
          echo "=========================================="
          echo "STEP 3e: Domain availability checks"
          echo "=========================================="
          echo "Testing: POST /dnszone/checkavailability"
          echo ""

          # Use EU company domains
          DOMAINS=(
            "siemens.com"
            "shell.com"
            "nestle.com"
            "sap.com"
            "lvmh.com"
            "unilever.com"
          )

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Checking availability: $domain"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            curl -v -X POST \
              -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"Name\": \"$domain\"}" \
              "$BUNNY_API_URL/dnszone/checkavailability" \
              2>&1 | tee "availability-${domain}.log"

            echo ""
            echo "Pretty-printed:"
            RESPONSE=$(tail -1 "availability-${domain}.log")
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

            # Small delay between requests
            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: Domain Availability Tests"
          echo "=========================================="

      # =================================================================
      # STEP 3f: EXPLORE - DNS scanning
      # =================================================================
      - name: Step 3f - Test DNS scanning endpoint
        run: |
          echo "=========================================="
          echo "STEP 3f: DNS scanning tests"
          echo "=========================================="
          echo "Testing: POST /dnszone/records/scan"
          echo ""

          # Use EU company domains (already created in Step 3d)
          DOMAINS=(
            "siemens.com"
            "shell.com"
            "nestle.com"
          )

          for domain in "${DOMAINS[@]}"; do
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "Scanning DNS records: $domain"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # Trigger scan using Domain parameter
            curl -v -X POST \
              -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"Domain\": \"$domain\"}" \
              "$BUNNY_API_URL/dnszone/records/scan" \
              2>&1 | tee "scan-${domain}.log"

            echo ""
            echo "Pretty-printed:"
            RESPONSE=$(tail -1 "scan-${domain}.log")
            echo "$RESPONSE" | jq '.' 2>/dev/null || echo "$RESPONSE"

            # Extract JobId if scan was triggered
            JOB_ID=$(echo "$RESPONSE" | jq -r '.JobId // empty' 2>/dev/null)
            if [ -n "$JOB_ID" ]; then
              echo "âœ… Scan triggered for $domain (JobId: $JOB_ID)"
              echo "JOB_${domain/./_}=$JOB_ID" >> $GITHUB_ENV
            fi

            # Small delay between requests
            sleep 1
          done

          echo ""
          echo "=========================================="
          echo "Summary: DNS Scanning Tests"
          echo "=========================================="

      # =================================================================
      # STEP 4: CLEANUP - Delete the test zone
      # =================================================================
      - name: Step 4 - Delete test zone
        if: always()
        run: |
          echo "=========================================="
          echo "STEP 4: Cleanup - Delete test zone"
          echo "=========================================="

          # Get all zone IDs
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq -r '.Items[]?.Id // empty' > zone-ids-final.txt

          if [ ! -s zone-ids-final.txt ]; then
            echo "âœ“ No zones to delete"
            exit 0
          fi

          echo "Zones to delete:"
          cat zone-ids-final.txt

          while read -r zone_id; do
            if [ -n "$zone_id" ]; then
              echo ""
              echo "â†’ Deleting zone ID: $zone_id"

              curl -v -X DELETE \
                -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
                "$BUNNY_API_URL/dnszone/$zone_id" \
                2>&1 | tee "cleanup-zone-${zone_id}.log"

              echo "âœ“ Deleted zone $zone_id"
              sleep 1
            fi
          done < zone-ids-final.txt

      - name: Step 4 - Verify final cleanup
        if: always()
        run: |
          echo "=========================================="
          echo "STEP 4: Verify final cleanup"
          echo "=========================================="

          curl -v \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            2>&1 | tee zones-final.log

          echo ""
          echo "Pretty-printed:"
          curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.'

          ZONE_COUNT=$(curl -s \
            -H "AccessKey: ${{ secrets.BUNNY_API_TEST_KEY }}" \
            "$BUNNY_API_URL/dnszone" \
            | jq '.Items | length')

          echo ""
          echo "Final zone count: $ZONE_COUNT"

          if [ "$ZONE_COUNT" != "0" ]; then
            echo "âœ— WARNING: Account is not empty after cleanup!"
            exit 1
          fi

          echo "âœ“ Account is empty - cleanup successful"

      # =================================================================
      # SUMMARY
      # =================================================================
      - name: Summary
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "BASIC TEST SUMMARY"
          echo "=========================================="
          echo ""
          echo "âœ“ Step 1: Cleanup - Deleted existing zones"
          echo "âœ“ Step 2: Verify - Confirmed account empty"
          echo "âœ“ Step 3: Create - Added test zone"
          echo "âœ“ Step 4: Cleanup - Removed test zone"
          echo ""
          echo "All basic operations working! âœ…"
          echo ""
          echo "Next: Add more exploration steps as needed"

      - name: Upload logs as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: basic-test-logs
          path: |
            *.log
            *.json
            *.txt
          retention-days: 30
