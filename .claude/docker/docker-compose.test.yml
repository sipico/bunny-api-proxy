services:
  mockbunny:
    profiles: ["mock"]  # Only start in mock mode
    build:
      context: ../..
      dockerfile: .claude/docker/Dockerfile.mockbunny
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "/app/mockbunny", "health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 5s

  proxy:
    build:
      context: ../..
      dockerfile: Dockerfile
    environment:
      - ADMIN_PASSWORD=testpassword123
      - ENCRYPTION_KEY=12345678901234567890123456789012
      - LOG_LEVEL=debug
      - HTTP_PORT=8080
      - DATA_PATH=/data/proxy.db
      - BUNNY_API_URL=${BUNNY_API_URL:-http://mockbunny:8081}
      - BUNNY_API_KEY=${BUNNY_API_KEY:-test-api-key-for-mockbunny}
    depends_on:
      mockbunny:
        condition: service_healthy
        required: false  # Optional dependency - not needed for real API mode
    networks:
      - test-network
    healthcheck:
      test: ["CMD", "/app/bunny-api-proxy", "health"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s
    volumes:
      - /tmp/proxy-data:/data

  test-runner:
    build:
      context: ../..
      dockerfile: .claude/docker/Dockerfile.testrunner
    environment:
      - PROXY_URL=http://proxy:8080
      - MOCKBUNNY_URL=${MOCKBUNNY_URL:-http://mockbunny:8081}
      - ADMIN_PASSWORD=testpassword123
      - BUNNY_MASTER_API_KEY=${BUNNY_API_KEY:-test-api-key-for-mockbunny}
    depends_on:
      proxy:
        condition: service_healthy
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
    internal: true
